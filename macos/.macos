#!/usr/bin/env bash

# macOS System Defaults Configuration
# Run this script to apply macOS preferences
# Safe to run multiple times

echo "Configuring macOS defaults..."

# ============================================================================
# Computer Name (requires sudo, uncomment if desired)
# ============================================================================
# echo "=> Setting computer name to 'phyrexia'..."
# sudo scutil --set ComputerName "phyrexia"
# sudo scutil --set HostName "phyrexia"
# sudo scutil --set LocalHostName "phyrexia"
# sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName -string "phyrexia"

# ============================================================================
# Dock
# ============================================================================
echo "=> Configuring Dock..."

# Enable autohide
defaults write com.apple.dock autohide -bool true

# Set 1000 second delay before dock appears on hover (effectively permanent)
defaults write com.apple.dock autohide-delay -float 1000

# Remove dock autohide animation (instant show/hide when toggled)
defaults write com.apple.dock autohide-time-modifier -float 0

# Disable icon bouncing
defaults write com.apple.dock no-bouncing -bool true

# Change minimize/maximize window effect to scale (faster than genie)
defaults write com.apple.dock mineffect -string "scale"

# Don't animate opening applications from the Dock
defaults write com.apple.dock launchanim -bool false

# Speed up Mission Control animations
defaults write com.apple.dock expose-animation-duration -float 0.1

# Restart Dock to apply changes
killall Dock

# ============================================================================
# Menu Bar
# ============================================================================
echo "=> Configuring menu bar..."

# Automatically hide and show the menu bar
defaults write NSGlobalDomain _HIHideMenuBar -bool true

# ============================================================================
# Keyboard
# ============================================================================
echo "=> Configuring keyboard..."

# Set blazingly fast keyboard repeat rate (1 = 15ms between repeats, default: 6)
defaults write NSGlobalDomain KeyRepeat -int 1

# Set shorter delay until key repeat (10 = 150ms, default: 25)
defaults write NSGlobalDomain InitialKeyRepeat -int 10

# Disable press-and-hold for keys in favor of key repeat
defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false

# Enable full keyboard access for all controls (tab in modal dialogs)
defaults write NSGlobalDomain AppleKeyboardUIMode -int 3

# ============================================================================
# Keyboard Input Sources
# ============================================================================
echo "=> Configuring keyboard input sources..."

# Configure input sources (Canadian and Programmers QWERTY)
# Note: This requires a more complex approach due to nested dictionaries
defaults delete com.apple.HIToolbox AppleEnabledInputSources 2>/dev/null || true

defaults write com.apple.HIToolbox AppleEnabledInputSources -array \
  -dict InputSourceKind "Keyboard Layout" "KeyboardLayout ID" -int 29 "KeyboardLayout Name" "Canadian" \
  -dict InputSourceKind "Keyboard Layout" "KeyboardLayout ID" -int -27039 "KeyboardLayout Name" "Programmers QWERTY"

# Set Control+Space as the keyboard layout switcher shortcut
defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 60 "
  <dict>
    <key>enabled</key><true/>
    <key>value</key><dict>
      <key>type</key><string>standard</string>
      <key>parameters</key>
      <array>
        <integer>32</integer>
        <integer>49</integer>
        <integer>262144</integer>
      </array>
    </dict>
  </dict>
"

# ============================================================================
# Wallpaper
# ============================================================================
echo "=> Setting wallpaper..."

# Set One Dark solid color wallpaper
osascript -e "tell application \"System Events\" to tell every desktop to set picture to \"$HOME/Pictures/Wallpapers/one-dark-base-solid.png\""

# ============================================================================
# Window Animations
# ============================================================================
echo "=> Disabling window animations..."

# Increase window resize speed for Cocoa applications (nearly instant)
defaults write NSGlobalDomain NSWindowResizeTime -float 0.001

echo ""
echo "Done: macOS defaults configured"
echo ""
echo "Note: Dock is permanently hidden (toggle with Option+Command+D)"
echo "      Menu bar autohides on hover (Ctrl-Fn-F2 to toggle)"
echo "      Keyboard repeat set to fastest (requires logout to take effect)"
echo "      Wallpaper set to One Dark solid color"
echo "      All animations set to instant/minimal for maximum responsiveness"
